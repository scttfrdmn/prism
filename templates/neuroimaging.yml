name: "Neuroimaging Environment"
base: "ubuntu-22.04-server-lts"
description: "FSL + AFNI + ANTs + MRtrix + Neuroglancer for neuroimaging research"

build_steps:
  - name: "System preparation"
    script: |
      apt-get update -y && apt-get upgrade -y
      apt-get install -y build-essential curl wget software-properties-common git \
        python3 python3-pip python3-dev unzip libopenblas-dev gfortran \
        tcsh xvfb gnome-terminal libgl1-mesa-dev

  - name: "Install FSL"
    script: |
      # Add FSL repository
      wget -O- https://fsl.fmrib.ox.ac.uk/fsldownloads/fslinstaller.py > /tmp/fslinstaller.py
      python3 /tmp/fslinstaller.py -d /usr/local/fsl -q
      
      # Configure FSL
      echo 'FSLDIR=/usr/local/fsl' > /etc/fsl/fsl.sh
      echo '. ${FSLDIR}/etc/fslconf/fsl.sh' >> /etc/fsl/fsl.sh
      echo 'PATH=${FSLDIR}/bin:${PATH}' >> /etc/fsl/fsl.sh
      echo 'export FSLDIR PATH' >> /etc/fsl/fsl.sh
      echo '. /etc/fsl/fsl.sh' > /etc/profile.d/fsl.sh
      chmod +x /etc/profile.d/fsl.sh

  - name: "Install AFNI"
    script: |
      # Add AFNI repository
      add-apt-repository -y universe
      curl -O https://afni.nimh.nih.gov/pub/dist/bin/misc/@add_rcran_ubuntu_22.04
      tcsh @add_rcran_ubuntu_22.04
      
      # Install AFNI dependencies
      apt-get update -y
      apt-get install -y afni
      
      # Configure AFNI
      echo 'PATH=/usr/lib/afni/bin:${PATH}' > /etc/profile.d/afni.sh
      echo 'export PATH' >> /etc/profile.d/afni.sh
      chmod +x /etc/profile.d/afni.sh

  - name: "Install ANTs"
    script: |
      # Install ANTs from binaries
      mkdir -p /usr/local/ANTs
      curl -fsSL https://github.com/ANTsX/ANTs/releases/download/v2.4.1/ants-2.4.1-ubuntu-20.04-X64-gcc.zip -o /tmp/ants.zip
      unzip -qq /tmp/ants.zip -d /usr/local
      mv /usr/local/ants-2.4.1-ubuntu-20.04-X64-gcc/* /usr/local/ANTs/
      
      # Configure ANTs
      echo 'export ANTSPATH=/usr/local/ANTs/bin' > /etc/profile.d/ants.sh
      echo 'PATH=${ANTSPATH}:${PATH}' >> /etc/profile.d/ants.sh
      echo 'export PATH' >> /etc/profile.d/ants.sh
      chmod +x /etc/profile.d/ants.sh
      
      # Create symbolic links
      ln -sf /usr/local/ANTs/bin/* /usr/local/bin/

  - name: "Install MRtrix3"
    script: |
      # Install dependencies
      apt-get install -y git g++ python3 python3-numpy libeigen3-dev zlib1g-dev \
        libqt5core5a libqt5gui5 libqt5svg5-dev libgl1-mesa-dev libfftw3-dev \
        libtiff5-dev libpng-dev
      
      # Build MRtrix3 from source
      git clone https://github.com/MRtrix3/mrtrix3.git /tmp/mrtrix3
      cd /tmp/mrtrix3
      ./configure
      ./build
      ./set_path
      
      # Install globally
      cp -R /tmp/mrtrix3 /usr/local/
      echo 'export PATH=/usr/local/mrtrix3/bin:${PATH}' > /etc/profile.d/mrtrix3.sh
      chmod +x /etc/profile.d/mrtrix3.sh

  - name: "Install Neuroglancer"
    script: |
      # Install Node.js
      curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      apt-get install -y nodejs
      
      # Install Neuroglancer
      npm install -g neuroglancer
      
      # Create startup script
      cat > /usr/local/bin/start-neuroglancer << 'EOF'
      #!/bin/bash
      cd /tmp
      neuroglancer-server > /tmp/neuroglancer.log 2>&1 &
      echo "Neuroglancer server started at http://localhost:8080"
      EOF
      
      chmod +x /usr/local/bin/start-neuroglancer

  - name: "Setup user environment"
    script: |
      # Create default researcher user
      useradd -m -s /bin/bash researcher
      echo "researcher:password123" | chpasswd
      usermod -aG sudo researcher
      
      # Add software to PATH for all users
      echo 'source /etc/profile.d/fsl.sh' >> /etc/bash.bashrc
      echo 'source /etc/profile.d/afni.sh' >> /etc/bash.bashrc
      echo 'source /etc/profile.d/ants.sh' >> /etc/bash.bashrc
      echo 'source /etc/profile.d/mrtrix3.sh' >> /etc/bash.bashrc

  - name: "Install Python neuroimaging libraries"
    script: |
      # Install common Python neuroimaging packages
      pip3 install nibabel nilearn dipy nipype fmriprep pybids
      
      # Create virtual environment for researcher
      su - researcher -c "python3 -m venv ~/neuro_env"
      su - researcher -c "~/neuro_env/bin/pip install nibabel nilearn dipy nipype matplotlib jupyter"

  - name: "Cleanup"
    script: |
      apt-get autoremove -y && apt-get autoclean
      rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

validation:
  - name: "FSL installed"
    command: "which fsl"
    success: true
  
  - name: "AFNI available"
    command: "which afni"
    success: true
  
  - name: "ANTs available"
    command: "which antsRegistration"
    success: true
  
  - name: "MRtrix installed"
    command: "which mrview"
    success: true
  
  - name: "Python neuroimaging libraries"
    command: "pip3 list | grep nibabel"
    success: true
  
  - name: "User setup"
    command: "id researcher"
    success: true

tags:
  Name: "neuroimaging"
  Type: "research"
  Software: "FSL,AFNI,ANTs,MRtrix3,Neuroglancer"
  Purpose: "medical-imaging"

min_disk_size: 30