name: "R Research Environment"
base: "ubuntu-22.04-server-lts"
description: "R + RStudio Server + tidyverse packages for statistical analysis"

build_steps:
  - name: "System updates"
    script: |
      apt-get update -y && apt-get upgrade -y
      apt-get install -y build-essential curl wget software-properties-common

  - name: "Install R"
    script: |
      # Add R repository
      apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9
      add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
      apt-get update -y
      
      # Install R
      apt-get install -y r-base r-base-dev
      
      # Install common R packages
      R -e "install.packages(c('tidyverse','ggplot2','dplyr','readr','shiny'), repos='http://cran.rstudio.com/')"

  - name: "Install RStudio Server"
    script: |
      # Detect architecture and install appropriate RStudio Server
      ARCH=$(uname -m)
      if [ "$ARCH" = "x86_64" ]; then
        wget -O rstudio.deb https://download2.rstudio.org/server/jammy/amd64/rstudio-server-2023.06.1-524-amd64.deb
      else
        wget -O rstudio.deb https://download2.rstudio.org/server/jammy/arm64/rstudio-server-2023.06.1-524-arm64.deb
      fi
      
      # Install RStudio Server
      dpkg -i rstudio.deb || apt-get install -f -y
      systemctl enable rstudio-server
      
      # Configure RStudio
      echo "www-port=8787" >> /etc/rstudio/rserver.conf
      echo "server-daemonize=1" >> /etc/rstudio/rserver.conf

  - name: "Setup user environment"
    script: |
      # Create default researcher user
      useradd -m -s /bin/bash researcher
      echo "researcher:password123" | chpasswd
      usermod -aG sudo researcher

  - name: "Install additional packages"
    script: |
      # Install common data science tools
      apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
      
      # Install additional R packages
      R -e "install.packages(c('rmarkdown','knitr','plotly','DT','openxlsx'), repos='http://cran.rstudio.com/')"

  - name: "Cleanup"
    script: |
      apt-get autoremove -y && apt-get autoclean
      rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
      rm -f rstudio.deb

validation:
  - name: "R installed"
    command: "R --version"
    contains: "R version"
  
  - name: "RStudio Server configured"
    command: "systemctl is-enabled rstudio-server"
    equals: "enabled"
  
  - name: "Tidyverse available"
    command: "R -e 'library(tidyverse)'"
    success: true
  
  - name: "User setup"
    command: "id researcher"
    success: true
  
  - name: "RStudio port configured"
    command: "grep www-port /etc/rstudio/rserver.conf"
    contains: "8787"

tags:
  Name: "r-research"
  Type: "research"
  Software: "R,RStudio,tidyverse"
  Purpose: "statistical-analysis"