# CloudWorkstation v0.4.2 Pre-Implementation Fixes

This document outlines critical issues identified during the codebase review that should be addressed before beginning v0.4.2 feature implementation.

## Critical Issues

### High Priority

1. **Implement EFS volume deletion in AWS Manager**
   - Current implementation returns "not implemented yet"
   - Need to add proper AWS API calls to delete EFS filesystem and mount targets
   - Update state management accordingly
   - File: `pkg/aws/manager.go`

2. **Add authentication layer for API endpoints**
   - Define authentication strategy (token-based or API keys)
   - Implement middleware for authentication
   - Add user context to requests
   - Update client to pass authentication information
   - Files: `pkg/daemon/server.go`, `pkg/api/client.go`

3. **Implement proper AWS credential region/profile passing**
   - Fix request header handling in API client
   - Ensure AWS SDK properly picks up profile/region from requests
   - Add validation and error handling
   - Files: `pkg/api/client.go`, `pkg/daemon/server.go`

4. **Integrate user management with daemon**
   - Create interface for daemon to use user management system
   - Update API handlers to check permissions
   - Add user context to operations
   - Files: `pkg/daemon/server.go`, `pkg/usermgmt/*.go`

### Medium Priority

1. **Address code duplication in api.Client.addRequestHeaders**
   - Remove duplicated code adding invitation token headers
   - Refactor for clarity and maintainability
   - File: `pkg/api/client.go` (lines ~240-280)

2. **Add comprehensive error types**
   - Create structured error types for different scenarios
   - Implement consistent error handling across API
   - Improve client error reporting
   - Files: `pkg/types/errors.go`, `pkg/api/*.go`

3. **Create proper API versioning strategy**
   - Define versioning approach (URL path, headers, etc.)
   - Document API version guarantees
   - Implement version handling in server
   - Files: `pkg/daemon/server.go`, `pkg/api/client.go`

4. **Implement operation tracking and request counting**
   - Add tracking for in-progress operations
   - Implement request counters
   - Add reporting in status endpoint
   - Files: `pkg/daemon/server.go`, `pkg/types/types.go`

### Low Priority

1. **Update daemon status to include actual start time**
   - Track and report actual start time instead of current time
   - Add uptime calculations
   - File: `pkg/daemon/server.go`

2. **Add unit tests for profile package**
   - Improve test coverage for profile management
   - Add mocks for testing
   - Files: `pkg/profile/*_test.go`

## Implementation Approach

For each issue:
1. Create a detailed design document
2. Implement the solution
3. Add comprehensive tests
4. Update documentation

## Timeline

These issues should be addressed in approximately 1-2 weeks before starting the v0.4.2 feature implementation.

## Dependencies

Some issues have dependencies on others:
- Authentication layer should be implemented before user management integration
- API versioning strategy should be defined before significant API changes
- Error types should be defined before improving error handling

## Testing Requirements

- Unit tests for all fixed components
- Integration tests for authentication and AWS credential handling
- End-to-end tests for EFS volume deletion
- Regression tests for existing functionality